(defwidget bar []
    (box 
        :class "bar"
        :orientation "h"
        (left_container)
        (center_container)
        (right_container)
    )
)

(defwidget right_container []
    (box
        :class "right-container"
        :space-evenly false
        :halign "end"
        (time)
        (battery)
    )
)

(defwidget center_container []
    (box
        :class "center-container"
        :space-evenly false
        :halign "center"
        (window_w)
    )
)

(defwidget left_container [] 
    (box
        :class "left-container"
        :space-evenly false
        (hyprland)
        (workspaces)
    )
)

;; Utils

(defwidget metric [label value onchange]
    (box 
        :orientation "h"
        :class "metric"
        :space-evenly false
        (box :class "label" label)
        (scale 
            :min 0
            :max 101
            :active {onchange != ""}
            :value value
            :onchange onchange
        )
    )
)

;; Left container items

(deflisten workspaces :initial "[]" "bash ~/.config/eww/scripts/get_workspaces.sh")
(deflisten current_workspace :initial "1" "bash ~/.config/eww/scripts/get_active_workspace.sh")
(defwidget workspaces []
    (eventbox 
        :onscroll "bash ~/.config/eww/scripts/change_active_workspace.sh {} ${current_workspace}" 
        :class "workspaces"
        (box 
            :space-evenly true
            (label 
                :text "${workspaces}${current_workspace}" 
                :visible false)
            (for workspace in workspaces
                (eventbox :onclick "hyprctl dispatch workspace ${workspace.id}"
                    (box :class "workspace-entry ${workspace.id == current_workspace ? "current" : ""} ${workspace.windows > 0 ? "occupied" : "empty"}"
                        (label :text "${workspace.id}")
                    )
                )
            )
        )
    )
)


;; Center container items

(deflisten window :initial "..." "sh ~/.config/eww/scripts/get_window_title.sh")
(defwidget window_w []
  (box
    :class "window_w"
    (label :text "${window}")
  )
)

(defwidget hyprland []
    (eventbox
        ;; :onclick "bash ~/.config/eww/scripts/rofi/open_app_menu.sh"
        :onclick "bash ~/.config/eww/scripts/themes/click_to_switch.sh 2> ./logs/click_to_switch"
        (image
            :class "hypr-logo"
            :path "./images/icon.ico"
            :image-width 25
            :image-height 25
        )
    )
)

;; Right container items

(defpoll show_time 
    :interval "10s"
    :class "time"
    "date '+%H:%M %b %d, %Y'"
)

(defwidget time []
    (box
        :space-evenly false
        :halign "center"
        :class "time"
        show_time
    )
)

(defpoll battery_remaining 
    :class "battery_remaining"
    :interval "10s"
    "acpi -b | awk -F ', ' '{print$2}'"
)

(defpoll battery_charging
    :interval "10s"
    "./scripts/battery/is_charging.sh"
)

(defwidget battery []
    (box
        :class "battery"
        (metric 
            :orientation "horizontal"
            :halign "center"
            :label "ï‰€  "
            :value 100
            :onchange "acpi -b"
        )
        battery_remaining
    )
)

;; Windows

(defwindow bar
    :monitor 0
    :windowtype "dock"
    :geometry (geometry 
        :x "0%"
        :y "0%"
        :width "100%"
        :height "2%"
        :anchor "top center"
    )
    :stacking "bg"
    :exclusive true
    (bar)
)
